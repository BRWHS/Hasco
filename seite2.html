
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Zimmerauswahl – hasco</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Open Sans', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 300px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease-in-out;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid #eee;
    }
    .card-content {
      padding: 15px;
      flex: 1;
    }
    .card h2 {
      font-size: 18px;
      margin: 0 0 10px;
    }
    .card p {
      margin: 5px 0;
      font-size: 14px;
      color: #888;
    }
    .card button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-size: 16px;
      border-top: 1px solid #ddd;
    }
    .card button:hover {
      background-color: #0056b3;
    }
    .more-text {
      display: none;
      margin-top: 5px;
      color: #666;
      font-size: 13px;
      line-height: 1.4;
    }
    .toggle-btn {
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      padding: 0;
      font-size: 13px;
      margin-top: 5px;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Zimmerauswahl – Schritt 2</h1>
  <div class="grid" id="zimmer-grid"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.3/dist/umd/supabase.min.js"></script>
<script>
  const zimmerDaten = [];
  const hotelName = new URLSearchParams(window.location.search).get("hotel");

  const { createClient } = supabase;
  const supabaseClient = createClient(
    'https://tqivbegnjwschwgrkqfm.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaXZiZWduandzY2h3Z3JrcWZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNDUxMTUsImV4cCI6MjA2MzkyMTExNX0.WidRDEm8ATqtXW8QcUs_biK_gYdZebpnPyw0PWQ1qKw'
  );

  function renderCards() {
    const grid = document.getElementById("zimmer-grid");
    const daten = zimmerDaten.filter(z => z.Hotel === hotelName);

    daten.forEach((zimmer, i) => {
      const imgPath = "img/" + (zimmer["Bild link"] || "fallback.jpg");
      const moreId = "more-" + i;
      const btnId = "btn-" + i;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${imgPath}" alt="${zimmer.Kategorie}" onerror="this.src='img/fallback.jpg'">
        <div class="card-content">
          <h2>${zimmer.Kategorie}</h2>
          <p><strong>Hotel:</strong> ${zimmer.Hotel}</p>
          <p><strong>Belegung:</strong> ${zimmer.Bedingung || "-"}</p>
          <p>
            ${zimmer.Beschreibung.split("\n")[0]}
            <span class="more-text" id="${moreId}"><br>${zimmer.Beschreibung.replaceAll("\n", "<br>")}</span>
            <button class="toggle-btn" id="${btnId}" onclick="toggleText('${moreId}', '${btnId}')">Mehr anzeigen</button>
          </p>
        </div>
        <button onclick="saveBooking('${zimmer.Kategorie}')">Diese Kategorie wählen</button>
      `;
      grid.appendChild(card);
    });
  }

  function toggleText(id, btnId) {
    const el = document.getElementById(id);
    const btn = document.getElementById(btnId);
    const isHidden = el.style.display === "none" || el.style.display === "";
    el.style.display = isHidden ? "inline" : "none";
    btn.textContent = isHidden ? "Weniger anzeigen" : "Mehr anzeigen";
  }

  async function saveBooking(kategorie) {
    const data = JSON.parse(sessionStorage.getItem("buchung") || "{}");
    if (!data || !data.hotel || !data.email || !data.lastName) {
      alert("❌ Fehler: Buchungsdaten unvollständig.");
      return;
    }

    const booking = {
      hotel: data.hotel,
      check_in: data.checkin,
      check_out: data.checkout,
      guest_first_name: data.firstName,
      guest_last_name: data.lastName,
      email: data.email,
      phone: data.phone,
      notes: data.notes,
      category: kategorie
    };

    const { error } = await supabaseClient.from("bookings").insert([booking]);
    if (error) {
      console.error(error);
      alert("❌ Fehler beim Speichern.");
    } else {
      alert("✅ Buchung gespeichert!");
      sessionStorage.clear();
      window.location.href = "danke.html";
    }
  }

  renderCards();
</script>
</body>
</html>
