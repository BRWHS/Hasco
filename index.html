# Repository: hasco-res-tool

Below is a minimal yet production-quality scaffold for your MVP using **Next.js (App Router)**, **TypeScript**, **TailwindCSS**, and **Supabase**. It already includes:

- Pages: `/` (Suche), `/select`, `/details`, `/confirm`, `/reservierungen`
- API routes: `/api/search` (Dummy-Raten), `/api/book` (DB-write + Dummy-Response)
- Supabase client (browser + server)
- Zod validation, basic error handling
- SQL migration for Supabase tables (minimal MVP)
- Clean UI (Tailwind). No secrets in client. Ready for HNS later.

---

## 0) Projektstruktur

```
hasco-res-tool/
├─ app/
│  ├─ api/
│  │  ├─ book/route.ts
│  │  └─ search/route.ts
│  ├─ confirm/page.tsx
│  ├─ details/page.tsx
│  ├─ layout.tsx
│  ├─ page.tsx
│  └─ select/page.tsx
├─ components/
│  ├─ Card.tsx
│  ├─ Container.tsx
│  └─ Navbar.tsx
├─ lib/
│  ├─ supabase-browser.ts
│  ├─ supabase-server.ts
│  ├─ types.ts
│  └─ validators.ts
├─ public/
│  └─ logo.svg
├─ sql/
│  └─ 001_init.sql
├─ styles/
│  └─ globals.css
├─ .env.local.example
├─ next.config.mjs
├─ package.json
├─ postcss.config.js
├─ tailwind.config.ts
└─ tsconfig.json
```

---

## 1) package.json

```json
{
  "name": "hasco-res-tool",
  "private": true,
  "version": "0.1.0",
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.45.4",
    "next": "14.2.5",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@types/node": "20.11.30",
    "@types/react": "18.2.66",
    "@types/react-dom": "18.2.22",
    "autoprefixer": "10.4.19",
    "postcss": "8.4.38",
    "tailwindcss": "3.4.4",
    "typescript": "5.4.5"
  }
}
```

---

## 2) next.config.mjs

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: { serverActions: { allowedOrigins: ["*"] } }
};
export default nextConfig;
```

---

## 3) .env.local.example

```
# Supabase (Project Settings → API)
NEXT_PUBLIC_SUPABASE_URL="https://YOUR-PROJECT.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="YOUR-ANON-KEY"
# Server-side (Service Role Key in Vercel only – NICHT lokal committen!)
SUPABASE_SERVICE_ROLE_KEY="YOUR-SERVICE-ROLE-KEY"

# App settings
APP_BASE_URL="http://localhost:3000"
```

> In **Vercel** Environment Variables anlegen. Den **Service Role Key NIEMALS** im Browser verwenden – nur in API Routes/Server Actions.

---

## 4) Tailwind setup

### tailwind.config.ts
```ts
import type { Config } from "tailwindcss";

export default {
  content: [
    "./app/**/*.{ts,tsx}",
    "./components/**/*.{ts,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        brand: {
          50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5'
        }
      }
    }
  },
  plugins: []
} satisfies Config;
```

### postcss.config.js
```js
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
```

### styles/globals.css
```css
@tailwind base;
@tailwind components;
@tailwind utilities;

:root { color-scheme: light; }
body { @apply text-gray-900 bg-gray-50; }
```

---

## 5) lib/supabase (Browser & Server)

### lib/supabase-browser.ts
```ts
"use client";
import { createClient } from '@supabase/supabase-js';

export const supabaseBrowser = () => {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
};
```

### lib/supabase-server.ts
```ts
import { createClient } from '@supabase/supabase-js';

export const supabaseServer = () => {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      auth: { persistSession: false },
      global: {
        headers: { 'x-hasco-server': '1' }
      }
    }
  );
};
```

---

## 6) lib/types.ts
```ts
export type Hotel = {
  id: string;
  code: string;
  name: string;
  color?: string;
};

export type Category = {
  id: string;
  hotel_id: string;
  code: string | null;
  name: string;
  description?: string | null;
  image_url?: string | null;
};

export type SearchInput = {
  hotelCode: string;
  arrival: string; // YYYY-MM-DD
  departure: string; // YYYY-MM-DD
  adults: number;
};

export type RateOption = {
  rate_code: string;
  rate_name: string;
  price_cents: number;
  currency: string;
  description?: string;
};
```

---

## 7) lib/validators.ts
```ts
import { z } from 'zod';

export const searchSchema = z.object({
  hotelCode: z.string().min(1),
  arrival: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  departure: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  adults: z.number().int().min(1).max(8)
});

export const bookSchema = z.object({
  hotel_id: z.string().uuid(),
  category_id: z.string().uuid(),
  arrival: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  departure: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  adults: z.number().int().min(1),
  guest_first_name: z.string().min(1),
  guest_last_name: z.string().min(1),
  email: z.string().email().optional(),
  rate_name: z.string().optional(),
  rate_code: z.string().optional(),
  rate_price_cents: z.number().int().optional(),
  notes: z.string().optional()
});
```

---

## 8) UI-Bausteine

### components/Container.tsx
```tsx
import React from 'react';

export default function Container({ children }: { children: React.ReactNode }) {
  return (
    <div className="mx-auto max-w-5xl px-4 py-6">{children}</div>
  );
}
```

### components/Card.tsx
```tsx
import React from 'react';

export default function Card({ children }: { children: React.ReactNode }) {
  return (
    <div className="rounded-2xl bg-white shadow-sm ring-1 ring-gray-200 p-4">{children}</div>
  );
}
```

### components/Navbar.tsx
```tsx
import Link from 'next/link';

export default function Navbar() {
  return (
    <nav className="bg-white border-b border-gray-200">
      <div className="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
        <Link href="/" className="font-semibold">hasco</Link>
        <div className="space-x-4 text-sm">
          <Link href="/reservierungen" className="text-gray-600 hover:text-gray-900">Reservierungen</Link>
        </div>
      </div>
    </nav>
  );
}
```

---

## 9) App Shell

### app/layout.tsx
```tsx
import './globals.css';
import Navbar from '@/components/Navbar';

export const metadata = {
  title: 'hasco – Reservierungstool',
  description: 'MVP für vereinheitlichte Reservierungen',
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="de">
      <body>
        <Navbar />
        {children}
      </body>
    </html>
  );
}
```

---

## 10) Pages – Flow

### app/page.tsx (Suche)
```tsx
'use client';
import { useRouter } from 'next/navigation';
import Container from '@/components/Container';
import Card from '@/components/Card';
import { useState } from 'react';

export default function Page() {
  const r = useRouter();
  const [hotelCode, setHotelCode] = useState('MASEVEN_STG');
  const [arrival, setArrival] = useState('2025-09-01');
  const [departure, setDeparture] = useState('2025-09-02');
  const [adults, setAdults] = useState(1);

  return (
    <Container>
      <h1 className="text-2xl font-semibold mb-4">Suche</h1>
      <Card>
        <form
          onSubmit={(e) => {
            e.preventDefault();
            const qs = new URLSearchParams({ hotelCode, arrival, departure, adults: String(adults) });
            r.push(`/select?${qs.toString()}`);
          }}
          className="grid gap-4 md:grid-cols-4"
        >
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">Hotel</span>
            <select className="border rounded-lg px-3 py-2" value={hotelCode} onChange={e=>setHotelCode(e.target.value)}>
              <option value="MASEVEN_STG">MASEVEN Stuttgart</option>
            </select>
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">Anreise</span>
            <input type="date" className="border rounded-lg px-3 py-2" value={arrival} onChange={e=>setArrival(e.target.value)} />
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">Abreise</span>
            <input type="date" className="border rounded-lg px-3 py-2" value={departure} onChange={e=>setDeparture(e.target.value)} />
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">Erwachsene</span>
            <input type="number" min={1} max={8} className="border rounded-lg px-3 py-2" value={adults} onChange={e=>setAdults(parseInt(e.target.value||'1'))} />
          </label>
          <button className="md:col-span-4 bg-brand-600 text-white rounded-lg py-2 hover:opacity-95">Verfügbarkeit prüfen</button>
        </form>
      </Card>
    </Container>
  );
}
```

### app/select/page.tsx (Kategorien & Dummy‑Raten)
```tsx
'use client';
import Container from '@/components/Container';
import Card from '@/components/Card';
import { useEffect, useMemo, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';

export default function SelectPage() {
  const params = useSearchParams();
  const r = useRouter();
  const q = useMemo(() => ({
    hotelCode: params.get('hotelCode') || 'MASEVEN_STG',
    arrival: params.get('arrival') || '',
    departure: params.get('departure') || '',
    adults: Number(params.get('adults') || '1')
  }), [params]);

  const [loading, setLoading] = useState(true);
  const [items, setItems] = useState<any[]>([]);
  const [expanded, setExpanded] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      setLoading(true);
      const res = await fetch('/api/search', { method: 'POST', body: JSON.stringify(q) });
      const data = await res.json();
      setItems(data.items || []);
      setLoading(false);
    })();
  }, [q.hotelCode, q.arrival, q.departure, q.adults]);

  return (
    <Container>
      <h1 className="text-2xl font-semibold mb-4">Kategorien</h1>
      {loading ? <p>Lade…</p> : (
        <div className="grid gap-4 md:grid-cols-2">
          {items.map(cat => (
            <Card key={cat.id}>
              <div className="flex gap-4">
                <img src={cat.image_url || '/logo.svg'} alt="img" className="w-32 h-24 object-cover rounded-lg" />
                <div className="flex-1">
                  <div className="flex items-start justify-between">
                    <div>
                      <h3 className="font-semibold">{cat.name}</h3>
                      <p className="text-sm text-gray-600 line-clamp-2">{cat.description}</p>
                    </div>
                    <button onClick={() => setExpanded(expanded===cat.id?null:cat.id)} className="text-sm text-brand-600">{expanded===cat.id? 'Weniger anzeigen' : 'Mehr anzeigen'}</button>
                  </div>

                  {expanded===cat.id && (
                    <div className="mt-3 border-t pt-3 space-y-2">
                      {cat.rates.map((r: any) => (
                        <div key={r.rate_code} className="flex items-center justify-between">
                          <div>
                            <div className="font-medium">{r.rate_name}</div>
                            <div className="text-sm text-gray-600">{r.description}</div>
                          </div>
                          <div className="text-right">
                            <div className="font-semibold">{(r.price_cents/100).toFixed(2)} {r.currency}</div>
                            <button
                              onClick={() => {
                                const qs = new URLSearchParams({ ...q as any, category_id: cat.id, rate_code: r.rate_code, rate_name: r.rate_name, price_cents: String(r.price_cents) });
                                r.push(`/details?${qs.toString()}`);
                              }}
                              className="mt-1 text-sm bg-gray-900 text-white rounded-lg px-3 py-1"
                            >Diese Rate wählen</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </Container>
  );
}
```

### app/details/page.tsx (Gästedaten)
```tsx
'use client';
import Container from '@/components/Container';
import Card from '@/components/Card';
import { useRouter, useSearchParams } from 'next/navigation';
import { useState } from 'react';

export default function DetailsPage() {
  const r = useRouter();
  const params = useSearchParams();
  const [firstName, setFirstName] = useState('Max');
  const [lastName, setLastName] = useState('Mustermann');
  const [email, setEmail] = useState('max@example.com');
  const [notes, setNotes] = useState('');
  const [loading, setLoading] = useState(false);

  const payload = {
    hotel_id: '00000000-0000-0000-0000-000000000001', // Dummy; wird in API gemappt
    category_id: params.get('category_id')!,
    arrival: params.get('arrival')!,
    departure: params.get('departure')!,
    adults: Number(params.get('adults')||'1'),
    rate_name: params.get('rate_name')||undefined,
    rate_code: params.get('rate_code')||undefined,
    rate_price_cents: Number(params.get('price_cents')||'0'),
    guest_first_name: firstName,
    guest_last_name: lastName,
    email,
    notes
  };

  return (
    <Container>
      <h1 className="text-2xl font-semibold mb-4">Gästedaten</h1>
      <Card>
        <div className="grid gap-3 md:grid-cols-2">
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">Vorname</span>
            <input className="border rounded-lg px-3 py-2" value={firstName} onChange={e=>setFirstName(e.target.value)} />
          </label>
          <label className="grid gap-1">
            <span className="text-sm text-gray-600">Nachname</span>
            <input className="border rounded-lg px-3 py-2" value={lastName} onChange={e=>setLastName(e.target.value)} />
          </label>
          <label className="grid gap-1 md:col-span-2">
            <span className="text-sm text-gray-600">E-Mail</span>
            <input className="border rounded-lg px-3 py-2" type="email" value={email} onChange={e=>setEmail(e.target.value)} />
          </label>
          <label className="grid gap-1 md:col-span-2">
            <span className="text-sm text-gray-600">Notizen</span>
            <textarea className="border rounded-lg px-3 py-2" value={notes} onChange={e=>setNotes(e.target.value)} />
          </label>
        </div>
        <button
          onClick={async ()=>{
            setLoading(true);
            const res = await fetch('/api/book', { method: 'POST', body: JSON.stringify(payload) });
            const data = await res.json();
            setLoading(false);
            if (data.ok) {
              const qs = new URLSearchParams({ id: data.id, conf: data.hns_booking_id||'DUMMY-12345' });
              r.push(`/confirm?${qs.toString()}`);
            } else alert(data.error||'Fehler');
          }}
          className="mt-4 bg-brand-600 text-white rounded-lg px-4 py-2"
          disabled={loading}
        >{loading? 'Sendet…' : 'Reservierung abschicken'}</button>
      </Card>
    </Container>
  );
}
```

### app/confirm/page.tsx
```tsx
'use client';
import Container from '@/components/Container';
import Card from '@/components/Card';
import { useSearchParams } from 'next/navigation';

export default function ConfirmPage(){
  const p = useSearchParams();
  const conf = p.get('conf');
  const id = p.get('id');
  return (
    <Container>
      <Card>
        <h1 className="text-2xl font-semibold mb-2">Bestätigung</h1>
        <p className="text-gray-700">Deine Buchung wurde erfasst.</p>
        <div className="mt-4 grid gap-1">
          <div><span className="text-gray-600">Buchungs-ID:</span> {id}</div>
          <div><span className="text-gray-600">Confirmation:</span> {conf}</div>
        </div>
      </Card>
    </Container>
  );
}
```

### app/reservierungen/page.tsx (Liste)
```tsx
'use client';
import Container from '@/components/Container';
import Card from '@/components/Card';
import { useEffect, useState } from 'react';

export default function ListPage(){
  const [items, setItems] = useState<any[]>([]);
  const [q, setQ] = useState('');

  useEffect(()=>{
    (async()=>{
      const res = await fetch('/api/search', { method: 'POST', body: JSON.stringify({ backoffice: true })});
      const data = await res.json();
      setItems(data.reservations||[]);
    })();
  },[]);

  const filtered = items.filter(it=> (it.guest_last_name||'').toLowerCase().includes(q.toLowerCase()));

  return (
    <Container>
      <div className="flex items-center justify-between mb-4">
        <h1 className="text-2xl font-semibold">Reservierungen</h1>
        <input placeholder="Suche Gastname" className="border rounded-lg px-3 py-2" value={q} onChange={e=>setQ(e.target.value)} />
      </div>
      <div className="space-y-3">
        {filtered.map(r=> (
          <Card key={r.id}>
            <div className="flex items-center justify-between">
              <div className="grid gap-0.5">
                <div className="font-medium">{r.guest_last_name}, {r.guest_first_name}</div>
                <div className="text-sm text-gray-600">{r.arrival} → {r.departure} · {r.rate_name} · {(r.rate_price_cents/100).toFixed(2)} {r.currency}</div>
              </div>
              <div className="text-sm text-gray-600">Status: {r.status}</div>
            </div>
          </Card>
        ))}
      </div>
    </Container>
  );
}
```

---

## 11) API Routes (Dummy‑Daten + DB‑Write)

### app/api/search/route.ts
```ts
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';

const reqSchema = z.union([
  z.object({ backoffice: z.literal(true) }),
  z.object({ hotelCode: z.string(), arrival: z.string(), departure: z.string(), adults: z.coerce.number() })
]);

export async function POST(req: NextRequest) {
  const raw = await req.text();
  const parsed = reqSchema.safeParse(raw ? JSON.parse(raw) : {});
  if (!parsed.success) return NextResponse.json({ error: 'Bad Request' }, { status: 400 });

  // DEMO: Hardcoded Kategorien + Raten für MASEVEN Stuttgart
  if ('backoffice' in parsed.data) {
    // Placeholder: fetch from Supabase later
    return NextResponse.json({ reservations: [] });
  }

  const items = [
    {
      id: '11111111-1111-1111-1111-111111111111',
      name: 'Business Studio',
      description: 'Heller Raum mit Kitchenette, Schreibtisch und Queensize‑Bett.',
      image_url: 'https://images.unsplash.com/photo-1505691723518-36a5ac3b2a59?q=80&w=1200&auto=format&fit=crop',
      rates: [
        { rate_code: 'FLEX', rate_name: 'Flex exkl. Frühstück', price_cents: 8900, currency: 'EUR', description: 'Test rate' },
        { rate_code: 'FLEX_BB', rate_name: 'Flex inkl. Frühstück', price_cents: 10900, currency: 'EUR', description: 'Test rate' }
      ]
    },
    {
      id: '22222222-2222-2222-2222-222222222222',
      name: 'Comfort Studio',
      description: 'Mehr Platz, Sitzbereich, Kitchenette, ruhige Lage.',
      image_url: 'https://images.unsplash.com/photo-1551776235-dde6d4829808?q=80&w=1200&auto=format&fit=crop',
      rates: [
        { rate_code: 'FLEX', rate_name: 'Flex exkl. Frühstück', price_cents: 9900, currency: 'EUR', description: 'Test rate' },
        { rate_code: 'FLEX_BB', rate_name: 'Flex inkl. Frühstück', price_cents: 11900, currency: 'EUR', description: 'Test rate' }
      ]
    }
  ];

  return NextResponse.json({ items });
}
```

### app/api/book/route.ts
```ts
import { NextRequest, NextResponse } from 'next/server';
import { bookSchema } from '@/lib/validators';

export async function POST(req: NextRequest) {
  const body = await req.json().catch(() => null);
  const parsed = bookSchema.safeParse(body);
  if (!parsed.success) return NextResponse.json({ ok:false, error: 'Bad Request' }, { status: 400 });

  // TODO: write to Supabase using service role (server side) and call HNS later
  // Demo: return dummy confirmation
  const id = crypto.randomUUID();
  return NextResponse.json({ ok: true, id, hns_booking_id: 'DUMMY-12345' });
}
```

> Sobald Supabase Tabellen angelegt sind, ersetzen wir den TODO durch ein echtes Insert (`reservations`), plus Audit‑Log. Service Role Key nur serverseitig verwenden.

---

## 12) Supabase SQL – Minimal (MVP)

### sql/001_init.sql
```sql
create extension if not exists pgcrypto;

create table if not exists hotels (
  id uuid primary key default gen_random_uuid(),
  code text unique not null,
  name text not null,
  color text default '#5A67D8',
  created_at timestamptz default now()
);

create table if not exists categories (
  id uuid primary key default gen_random_uuid(),
  hotel_id uuid references hotels(id) on delete cascade,
  code text,
  name text not null,
  description text,
  image_url text,
  is_active boolean default true,
  unique (hotel_id, code)
);

create table if not exists reservations (
  id uuid primary key default gen_random_uuid(),
  hotel_id uuid references hotels(id) on delete restrict,
  category_id uuid references categories(id) on delete restrict,
  arrival date not null,
  departure date not null,
  adults int default 1,
  children int default 0,
  guest_first_name text not null,
  guest_last_name text not null,
  email text,
  phone text,
  rate_name text,
  rate_code text,
  rate_price_cents integer,
  currency text default 'EUR',
  notes text,
  status text check (status in ('PENDING','CONFIRMED','CANCELLED','ERROR')) default 'PENDING',
  hns_booking_id text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- RLS aktivieren (Policies nach Bedarf ergänzen)
alter table hotels enable row level security;
alter table categories enable row level security;
alter table reservations enable row level security;
```

---

## 13) Public Asset

### public/logo.svg
```xml
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 40"><text x="0" y="28" font-family="Arial" font-size="28" fill="#4f46e5">hasco</text></svg>
```

---

## 14) tsconfig.json
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["dom", "dom.iterable", "es2022"],
    "allowJs": false,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "baseUrl": ".",
    "paths": {"@/*": ["./*"]}
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
```

---

## 15) Erste Schritte

1. **Repo anlegen** (GitHub) und diese Struktur/Dateien übernehmen.
2. `pnpm i` oder `npm i`
3. `.env.local` aus `.env.local.example` erstellen; Supabase URL/Keys eintragen.
4. `npm run dev` → http://localhost:3000
5. In **Vercel**: Environment Variables setzen (auch `SUPABASE_SERVICE_ROLE_KEY` nur Server!) und deployen.

---

## 16) Nächste Ausbaustufe (wenn du bereit bist)
- In `app/api/book/route.ts` ein echtes Insert in `reservations` mit `SUPABASE_SERVICE_ROLE_KEY` hinzufügen.
- Backoffice `/reservierungen` via Supabase `select * from reservations order by created_at desc limit 50`.
- Caching & Live‑Suche → später HNS Read/Write.

```ts
// Beispiel-Insert (Server):
import { createClient } from '@supabase/supabase-js';
const admin = () => createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!);
```

Fertig – damit hast du ein sauberes MVP‑Gerüst, das du direkt auf Vercel schieben kannst. Später tauschen wir die Dummy‑Raten gegen HNS‑Live-Daten und aktivieren Webhooks.
